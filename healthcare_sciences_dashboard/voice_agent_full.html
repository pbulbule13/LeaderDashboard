<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vinegar Voice Agent - Full Test Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="bg-white rounded-xl shadow-2xl p-8 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-4xl font-bold text-gray-800 mb-2">üéôÔ∏è Vinegar</h1>
                        <p class="text-gray-600">Your AI Executive Assistant with Voice</p>
                    </div>
                    <div class="text-right">
                        <div id="statusIndicator" class="flex items-center gap-2 mb-2">
                            <div class="w-3 h-3 bg-gray-400 rounded-full" id="statusDot"></div>
                            <span id="statusText" class="text-sm font-semibold text-gray-600">Checking...</span>
                        </div>
                        <button onclick="checkStatus()" class="text-xs text-blue-600 hover:underline">Refresh Status</button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-6">
                <!-- Left Column: Voice Interface -->
                <div class="col-span-2 space-y-6">
                    <!-- Voice Control Panel -->
                    <div class="bg-white rounded-xl shadow-xl p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">üé§ Voice Control</h2>

                        <!-- Microphone Button -->
                        <div class="text-center mb-6">
                            <button id="voiceButton" onclick="toggleVoiceRecording()"
                                class="w-32 h-32 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white shadow-2xl transition-all duration-300 transform hover:scale-105 flex items-center justify-center mx-auto">
                                <span id="voiceIcon" class="text-5xl">üé§</span>
                            </button>
                            <p id="voiceStatus" class="mt-4 text-sm font-semibold text-gray-600">Click to start voice input</p>
                        </div>

                        <!-- Text Input Fallback -->
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Or type your question:</label>
                            <textarea id="queryInput" rows="3"
                                placeholder="Try: 'What emails need my attention?' or 'Show me my calendar'"
                                class="w-full p-4 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"></textarea>
                        </div>

                        <!-- Action Buttons -->
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <button onclick="askVinegar()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-all">
                                üöÄ Ask Vinegar
                            </button>
                            <button onclick="speakResponse()" id="speakBtn" disabled
                                class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                üîä Speak Response
                            </button>
                        </div>

                        <!-- Quick Actions -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="text-sm font-semibold text-gray-700 mb-3">Quick Actions:</p>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="quickAction('inbox')" class="text-xs bg-blue-100 hover:bg-blue-200 text-blue-800 px-4 py-2 rounded-lg font-semibold transition-all">
                                    üìß Check Inbox
                                </button>
                                <button onclick="quickAction('urgent')" class="text-xs bg-red-100 hover:bg-red-200 text-red-800 px-4 py-2 rounded-lg font-semibold transition-all">
                                    üö® Urgent Emails
                                </button>
                                <button onclick="quickAction('calendar')" class="text-xs bg-purple-100 hover:bg-purple-200 text-purple-800 px-4 py-2 rounded-lg font-semibold transition-all">
                                    üìÖ Today's Calendar
                                </button>
                                <button onclick="quickAction('summary')" class="text-xs bg-green-100 hover:bg-green-200 text-green-800 px-4 py-2 rounded-lg font-semibold transition-all">
                                    üìä Daily Summary
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Response Area -->
                    <div id="responseArea" class="hidden bg-white rounded-xl shadow-xl p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">üí¨ Vinegar's Response:</h3>
                        <div id="responseText" class="bg-gray-50 p-4 rounded-lg text-gray-800 mb-4"></div>

                        <!-- Email Display -->
                        <div id="emailsSection" class="hidden">
                            <h4 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                <span>üìß</span> Your Emails
                            </h4>
                            <div id="emailsList" class="space-y-3"></div>
                        </div>

                        <!-- Drafts Display -->
                        <div id="draftsSection" class="hidden mt-4">
                            <h4 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                <span>‚úçÔ∏è</span> Generated Drafts
                            </h4>
                            <div id="draftsList" class="space-y-3"></div>
                        </div>
                    </div>

                    <!-- Loading -->
                    <div id="loadingIndicator" class="hidden bg-white rounded-xl shadow-xl p-8 text-center">
                        <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4"></div>
                        <p class="text-blue-600 font-semibold text-lg">Vinegar is thinking...</p>
                    </div>

                    <!-- Error -->
                    <div id="errorArea" class="hidden bg-red-50 border-2 border-red-200 rounded-xl p-6">
                        <h3 class="text-red-800 font-bold mb-2 text-lg">‚ö†Ô∏è Error</h3>
                        <p id="errorText" class="text-red-700"></p>
                    </div>
                </div>

                <!-- Right Column: System Info -->
                <div class="space-y-6">
                    <!-- System Status -->
                    <div class="bg-white rounded-xl shadow-xl p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">üìä System Status</h3>
                        <div class="space-y-3">
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <p class="text-xs text-gray-600 mb-1">API Server</p>
                                <p id="serverStatus" class="font-semibold">üîÑ Checking...</p>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <p class="text-xs text-gray-600 mb-1">Gmail Connection</p>
                                <p id="gmailStatus" class="font-semibold">üîÑ Checking...</p>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <p class="text-xs text-gray-600 mb-1">Voice Input</p>
                                <p id="micStatus" class="font-semibold">üé§ Available</p>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <p class="text-xs text-gray-600 mb-1">Voice Output</p>
                                <p id="ttsStatus" class="font-semibold">üîä Browser TTS</p>
                            </div>
                        </div>
                    </div>

                    <!-- Help Card -->
                    <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl shadow-xl p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-3">üí° How to Use</h3>
                        <div class="space-y-2 text-sm text-gray-700">
                            <p><strong>Voice:</strong> Click the microphone and speak</p>
                            <p><strong>Text:</strong> Type your question and click "Ask"</p>
                            <p><strong>Quick Actions:</strong> Use preset commands</p>
                            <p class="pt-2 border-t border-purple-200 mt-3"><strong>Example questions:</strong></p>
                            <ul class="text-xs space-y-1 ml-4 list-disc">
                                <li>"What emails need my attention?"</li>
                                <li>"Show me urgent emails"</li>
                                <li>"What's on my calendar today?"</li>
                                <li>"Draft a reply saying I'll review tomorrow"</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Configuration Info -->
                    <div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-6">
                        <h3 class="text-lg font-bold text-yellow-900 mb-3">‚öôÔ∏è Setup</h3>
                        <div class="text-sm text-yellow-800 space-y-2">
                            <p><strong>Gmail:</strong> Connected via OAuth2</p>
                            <p><strong>Voice Input:</strong> Uses browser's Speech Recognition</p>
                            <p><strong>Voice Output:</strong> Uses browser's Speech Synthesis or ElevenLabs (if configured)</p>
                            <p class="pt-2 text-xs">See <code class="bg-yellow-100 px-1 rounded">README.md</code> for ElevenLabs setup</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let recognition = null;
        let isRecording = false;
        let lastResponse = '';

        // Check if browser supports speech recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('queryInput').value = transcript;
                document.getElementById('voiceStatus').textContent = `You said: "${transcript}"`;
                setTimeout(() => askVinegar(), 500);
            };

            recognition.onerror = (event) => {
                document.getElementById('voiceStatus').textContent = `Error: ${event.error}`;
                stopRecording();
            };

            recognition.onend = () => {
                stopRecording();
            };
        } else {
            document.getElementById('micStatus').textContent = '‚ùå Not supported';
            document.getElementById('micStatus').className = 'font-semibold text-red-600';
        }

        // Check if browser supports speech synthesis
        if ('speechSynthesis' in window) {
            document.getElementById('ttsStatus').textContent = '‚úÖ Available';
            document.getElementById('ttsStatus').className = 'font-semibold text-green-600';

            // Load voices (they may not be ready immediately)
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = () => {
                    const voices = speechSynthesis.getVoices();
                    const femaleVoices = voices.filter(v =>
                        v.name.toLowerCase().includes('female') ||
                        v.name.toLowerCase().includes('woman') ||
                        v.name.toLowerCase().includes('samantha') ||
                        v.name.toLowerCase().includes('victoria') ||
                        v.name.toLowerCase().includes('zira') ||
                        v.name.toLowerCase().includes('susan') ||
                        v.name.toLowerCase().includes('karen')
                    );
                    if (femaleVoices.length > 0) {
                        document.getElementById('ttsStatus').textContent = `‚úÖ Female voice available`;
                    }
                };
            }
        }

        window.addEventListener('load', checkStatus);

        async function checkStatus() {
            try {
                const response = await fetch(`${API_URL}/health`);
                if (response.ok) {
                    document.getElementById('serverStatus').textContent = '‚úÖ Online';
                    document.getElementById('serverStatus').className = 'font-semibold text-green-600';
                    document.getElementById('statusDot').className = 'w-3 h-3 bg-green-500 rounded-full animate-pulse';
                    document.getElementById('statusText').textContent = 'Online';
                    document.getElementById('statusText').className = 'text-sm font-semibold text-green-600';

                    // Check Gmail
                    const configResponse = await fetch(`${API_URL}/voice-agent/config`);
                    if (configResponse.ok) {
                        document.getElementById('gmailStatus').textContent = '‚úÖ Connected';
                        document.getElementById('gmailStatus').className = 'font-semibold text-green-600';
                    }
                } else {
                    document.getElementById('serverStatus').textContent = '‚ùå Offline';
                    document.getElementById('serverStatus').className = 'font-semibold text-red-600';
                    document.getElementById('statusDot').className = 'w-3 h-3 bg-red-500 rounded-full';
                    document.getElementById('statusText').textContent = 'Offline';
                    document.getElementById('statusText').className = 'text-sm font-semibold text-red-600';
                }
            } catch (error) {
                document.getElementById('serverStatus').textContent = '‚ùå Offline';
                document.getElementById('serverStatus').className = 'font-semibold text-red-600';
                document.getElementById('gmailStatus').textContent = '‚ö†Ô∏è Unknown';
                document.getElementById('gmailStatus').className = 'font-semibold text-yellow-600';
                document.getElementById('statusDot').className = 'w-3 h-3 bg-red-500 rounded-full';
                document.getElementById('statusText').textContent = 'Offline';
                document.getElementById('statusText').className = 'text-sm font-semibold text-red-600';
            }
        }

        function toggleVoiceRecording() {
            if (!recognition) {
                alert('Speech recognition not supported in your browser. Please use Chrome, Edge, or Safari.');
                return;
            }

            if (isRecording) {
                recognition.stop();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            isRecording = true;
            document.getElementById('voiceButton').className = 'w-32 h-32 rounded-full bg-gradient-to-br from-red-500 to-pink-600 text-white shadow-2xl transition-all duration-300 animate-pulse flex items-center justify-center mx-auto';
            document.getElementById('voiceIcon').textContent = '‚è∫Ô∏è';
            document.getElementById('voiceStatus').textContent = 'Listening... Speak now';
            recognition.start();
        }

        function stopRecording() {
            isRecording = false;
            document.getElementById('voiceButton').className = 'w-32 h-32 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white shadow-2xl transition-all duration-300 transform hover:scale-105 flex items-center justify-center mx-auto';
            document.getElementById('voiceIcon').textContent = 'üé§';
            if (document.getElementById('voiceStatus').textContent === 'Listening... Speak now') {
                document.getElementById('voiceStatus').textContent = 'Click to start voice input';
            }
        }

        function quickAction(action) {
            const queries = {
                'inbox': 'What emails do I have in my inbox?',
                'urgent': 'Show me urgent emails that need my attention',
                'calendar': 'What is on my calendar today?',
                'summary': 'Give me a summary of my emails and calendar for today'
            };
            document.getElementById('queryInput').value = queries[action];
            askVinegar();
        }

        async function askVinegar() {
            const query = document.getElementById('queryInput').value;
            if (!query.trim()) {
                alert('Please enter a question!');
                return;
            }

            showLoading();
            hideError();
            hideResponse();

            try {
                const response = await fetch(`${API_URL}/voice-agent/query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: query,
                        mode: 'text'
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                lastResponse = data.text || 'Response received';
                displayResponse(data);
                document.getElementById('speakBtn').disabled = false;

                // Auto-speak if voice was used
                if (isRecording) {
                    setTimeout(() => speakResponse(), 500);
                }
            } catch (error) {
                showError(error.message);
            } finally {
                hideLoading();
            }
        }

        let currentAudio = null;

        async function speakResponse() {
            if (!lastResponse) {
                alert('No response to speak');
                return;
            }

            // Stop any currently playing audio
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }

            try {
                // Try ElevenLabs API first
                document.getElementById('speakBtn').textContent = '‚è≥ Generating...';
                document.getElementById('speakBtn').disabled = true;

                const response = await fetch(`${API_URL}/voice-agent/tts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: lastResponse })
                });

                if (response.ok) {
                    // ElevenLabs succeeded - play the audio
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    currentAudio = new Audio(audioUrl);

                    document.getElementById('speakBtn').textContent = 'üîä Speaking...';

                    currentAudio.play();

                    currentAudio.onended = () => {
                        document.getElementById('speakBtn').textContent = 'üîä Speak Response';
                        document.getElementById('speakBtn').disabled = false;
                        URL.revokeObjectURL(audioUrl);
                    };

                    currentAudio.onerror = () => {
                        document.getElementById('speakBtn').textContent = 'üîä Speak Response';
                        document.getElementById('speakBtn').disabled = false;
                        URL.revokeObjectURL(audioUrl);
                    };

                    return;
                }
            } catch (error) {
                console.warn('ElevenLabs TTS failed, falling back to browser TTS:', error);
            }

            // Fallback to browser TTS if ElevenLabs fails
            document.getElementById('speakBtn').disabled = false;
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(lastResponse);

                // Get available voices and select a female voice
                const voices = window.speechSynthesis.getVoices();
                const femaleVoice = voices.find(voice =>
                    voice.name.toLowerCase().includes('female') ||
                    voice.name.toLowerCase().includes('woman') ||
                    voice.name.toLowerCase().includes('samantha') ||
                    voice.name.toLowerCase().includes('victoria') ||
                    voice.name.toLowerCase().includes('zira') ||
                    voice.name.toLowerCase().includes('susan') ||
                    voice.name.toLowerCase().includes('karen')
                );

                if (femaleVoice) {
                    utterance.voice = femaleVoice;
                }

                utterance.rate = 1.0;
                utterance.pitch = 1.2;
                utterance.volume = 1.0;
                window.speechSynthesis.speak(utterance);

                document.getElementById('speakBtn').textContent = 'üîá Stop Speaking';
                utterance.onend = () => {
                    document.getElementById('speakBtn').textContent = 'üîä Speak Response';
                };
            } else {
                alert('Text-to-speech not supported in your browser');
            }
        }

        function displayResponse(data) {
            const responseArea = document.getElementById('responseArea');
            const responseText = document.getElementById('responseText');

            responseArea.classList.remove('hidden');
            responseText.textContent = data.text || 'Response received';

            // Display emails
            if (data.email_threads && data.email_threads.length > 0) {
                displayEmails(data.email_threads);
            }

            // Display drafts
            if (data.drafts && data.drafts.length > 0) {
                displayDrafts(data.drafts);
            }
        }

        function displayEmails(emails) {
            const section = document.getElementById('emailsSection');
            const list = document.getElementById('emailsList');

            section.classList.remove('hidden');
            list.innerHTML = emails.map(email => `
                <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg hover:shadow-md transition-all">
                    <div class="flex justify-between items-start mb-2">
                        <p class="font-semibold text-gray-900">${email.from || 'Unknown'}</p>
                        <span class="text-xs bg-blue-200 text-blue-800 px-2 py-1 rounded">${email.date || ''}</span>
                    </div>
                    <p class="font-medium text-gray-800 mb-1">${email.subject || 'No subject'}</p>
                    <p class="text-sm text-gray-600">${email.preview || ''}</p>
                </div>
            `).join('');
        }

        function displayDrafts(drafts) {
            const section = document.getElementById('draftsSection');
            const list = document.getElementById('draftsList');

            section.classList.remove('hidden');
            list.innerHTML = drafts.map(draft => `
                <div class="bg-green-50 border border-green-200 p-4 rounded-lg">
                    <p class="text-sm text-green-700 mb-2">To: ${draft.to ? draft.to.join(', ') : 'Unknown'}</p>
                    <p class="font-semibold mb-2">${draft.subject || 'No subject'}</p>
                    <div class="bg-white p-3 rounded text-sm whitespace-pre-wrap border border-green-200">${draft.body || ''}</div>
                </div>
            `).join('');
        }

        function showLoading() {
            document.getElementById('loadingIndicator').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingIndicator').classList.add('hidden');
        }

        function showError(message) {
            document.getElementById('errorArea').classList.remove('hidden');
            document.getElementById('errorText').textContent = message;
        }

        function hideError() {
            document.getElementById('errorArea').classList.add('hidden');
        }

        function hideResponse() {
            document.getElementById('responseArea').classList.add('hidden');
            document.getElementById('emailsSection').classList.add('hidden');
            document.getElementById('draftsSection').classList.add('hidden');
        }
    </script>
</body>
</html>
